# ミドルウェアとは
URLリクエスト前に実行される関数

安全性を担保するために実装されることが多い

## ユースケース

* 認証と認可 特定ページへのアクセスを行う前に権限をチェックする
* リダイレクト制御 ユーザーロールによるアクセス制御、使用しているブラウザの言語設定によるページリダイレクトなど
* その他APIレート制限やメンテナンスモードなど

# ミドルウェアの実装方法とmatcher
/appと同階層にmiddleware.tsを作成する
matcherで発火URLを指定できる（Matching Paths）

```
export const config = {
    matcher: [""]
}
```

正規表現もサポートされている
何も指定しない場合は全てのリクエストで発火してしまう
これはアンチパターン

# 避けるべきアンチパターンと制約条件
## DBクエリを使用した認可チェック
毎回DBにアクセスすることでレイテンシが増加するのでパフォーマンスの低下につながる
ミドルウェアでのDBクエリ実行は避けるべき
### 代替案
#### 楽観的チェック
ミドルウェアでクッキーの中身を見る
クッキー内のトークン(JWT)情報でユーザーの権限を判定
DBにアクセスしないので簡易チェックには良い
完全なセキュアではないことに注意
#### DALでチェック
DAL = Data Access Layer = データアクセス層
データ取得専用のファイル、関数を作っておく

注意点は共通レイアウトで認可チェックは危険
情報漏洩につながる恐れがある(RSC Payloadが漏れる可能性)

レイアウトとページは並行処理なので確実に認可チェックができない
ページ→レイアウトの順でレンダリングされることもある

# 重い処理の実行
ミドルウェアはEdge Runtimeで動作する(デフォルト)
## Edge Runtimeとは
ユーザーとの物理的に近い距離のサーバを利用する実行環境のこと
オリジンサーバよりも軽量なリソースしか利用できない
長時間の処理や大量のメモリを必要とする操作は記述しない
ServerComponentやAPI RoutesはデフォルトでNode.js環境
選択的にEdgeは組み込める

```
export const runtime = "edge"
```

## リクエスト毎に発火してしまう
何度も重い処理が走ってしまう
パフォーマンスの低下につながる

## 代替案
ServerComponentを利用する
Node.js環境内で実行可能

Node.js固有のAPI利用
全パスでの実行

# リクエスト毎に発火してしまう

